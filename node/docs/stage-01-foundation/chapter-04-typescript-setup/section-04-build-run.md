# 1.4.4 生产环境构建与运行

## 1. 概述

在生产环境下，Node.js 必须运行经过编译器优化后的纯 JavaScript 代码，而非原始的 TypeScript。为了在享受高性能原生执行的同时，依然能精准定位源码中的错误，我们需要建立一套完整的“构建-映射-追踪”逻辑闭环。本节将详细解析工业级 TypeScript 项目的构建全链路，并深入探讨 Source Map 映射机制及 Node.js 生产环境的运行参数优化。

## 2. 特性说明

- **原生性能执行**：运行纯净的 JavaScript 代码，完全消除运行时的内存转译开销与延迟。
- **源码映射 (Source Mapping)**：在产物报错时，物理重定向回原始 `.ts` 源码行号，极大降低排障难度。
- **产物原子化**：通过构建脚本确保编译产物（dist）的洁净性，剔除开发环境特有的冗余文件。
- **依赖最小化**：生产镜像仅需包含运行产物及 `dependencies`，显著缩小容器体积。

## 3. 生产级构建流水线

典型的生产构建流程遵循“源码分离、产物干净”的原则，包含以下四个物理阶段。

| 阶段名称         | 核心逻辑职责                                                       | 执行指令示例                           |
|:-----------------|:-------------------------------------------------------------------|:---------------------------------------|
| **1. 清理阶段**  | 删除旧的编译目录，防止重命名或删除后的旧代码残留导致逻辑污染。     | `rimraf dist`                          |
| **2. 类型校验**  | 开启全量类型审计，这是生产发布的最高级别逻辑准入门槛。             | `tsc --noEmit`                         |
| **3. 物理编译**  | 将 TS 转为 JS，并根据 `tsconfig` 生成 Source Map 及类型声明。       | `tsc`                                  |
| **4. 环境验证**  | 在仿真生产环境下运行编译产物，确保模块导入路径解析正确。           | `node dist/index.js`                   |

## 4. 参数说明：Source Map 映射参数

为了让 Node.js 运行时能够识别并正确映射物理磁盘上的 `.js.map` 文件，需开启特定参数。

| 参数项                 | 类型     | 逻辑作用说明                                     | 引入版本         |
|:-----------------------|:---------|:-------------------------------------------------|:-----------------|
| `--enable-source-maps` | Boolean  | 物理开启堆栈重写逻辑，使报错堆栈显示 `.ts` 行号。| Node.js 12.12+   |
| `--max-old-space-size` | Number   | 针对生产环境负载，手动调整 V8 堆内存上限。       | N/A              |

## 5. 返回值与状态说明：构建输出清单

执行 `tsc` 构建成功后，`dist` 目录下应产生以下物理文件，共同构成生产逻辑。

| 文件扩展名       | 逻辑职责说明                                     | 部署必要性     |
|:-----------------|:-------------------------------------------------|:---------------|
| **`.js`**        | 抹除类型后的纯逻辑代码。                         | **必须部署**   |
| **`.js.map`**    | 建立 JS 与 TS 之间的坐标映射关系。               | **推荐部署**   |
| **`.d.ts`**      | 供第三方项目引用的类型字典。                     | 仅包库需部署   |

## 6. 代码示例：错误追踪逻辑演示

以下脚本演示了生产环境下如何利用 Source Map 精准定位异步堆栈。

```ts
// 文件: src/error-trace.ts
// 功能: 演示生产环境下如何物理定位源码报错位置

function triggerInternalError() {
  // 假设在源码第 6 行
  throw new Error('[CRITICAL] 生产环境业务逻辑异常');
}

async function startApp() {
  console.log('[APP] 服务启动中...');
  triggerInternalError();
}

startApp().catch(err => {
  console.error(err);
});
```

## 7. 输出结果说明

**场景 A：未开启映射运行 (`node dist/error-trace.js`)**
```text
Error: [CRITICAL] 生产环境业务逻辑异常
    at triggerInternalError (dist/error-trace.js:3:9)
```

**场景 B：开启映射运行 (`node --enable-source-maps dist/error-trace.js`)**
```text
Error: [CRITICAL] 生产环境业务逻辑异常
    at triggerInternalError (src/error-trace.ts:6:9)
```

**逻辑解析**：在场景 B 中，Node.js 引擎在抛出错误前读取了同目录下的 `.js.map` 文件，将产物中第 3 行的物理位置自动转换回了源码第 6 行，这在大型分布式系统中是排查问题的生命线。

## 8. 注意事项与常见错误

- **Source Map 遗漏**：如果在发布时仅拷贝了 `.js` 而遗漏了 `.js.map`，`--enable-source-maps` 参数将失效且不会报错，导致排障行号对不上。
- **依赖残留**：切记不要将 `typescript` 放入 `dependencies`。这会导致生产环境镜像中包含不必要的编译器，增加受攻击面和内存负载。
- **软链接陷阱**：在使用软链接部署项目时，需确保 `sourceRoot` 在 Source Map 中配置为相对路径，否则在生产机器上可能无法定位源码。

## 9. 常见问题 (FAQ)

**Q: 开启 --enable-source-maps 会影响性能吗？**
A: 不会。Source Map 的解析逻辑仅在异常抛出、堆栈回溯或调试器接入时才会被触发。在正常的逻辑执行流中，它几乎不占用额外的 CPU 或内存。

**Q: 既然都要编译成 JS，为什么不直接写 JS？**
A: TypeScript 的价值在于“工程化契约”。在生产环境运行 JS 是为了性能，但在开发阶段使用 TS 是为了确保逻辑的正确性和团队协作的可维护性。

## 10. 最佳实践

- **多阶段构建 (Docker)**：在 `build` 阶段进行编译，在 `release` 阶段仅保留编译产物。
- **强制清理脚本**：将 `rimraf dist` 绑定到 `prebuild` 钩子中，确保每次构建都是基于洁净的物理状态。
- **日志持久化**：生产环境务必记录带 Source Map 映射后的错误堆栈到外部日志系统（如 ELK），以便事后溯源。

## 11. 对比分析：开发运行 vs 生产运行

| 维度             | 开发模式 (tsx/ts-node)                           | 生产模式 (tsc + node)                            |
|:-----------------|:-------------------------------------------------|:-------------------------------------------------|
| **执行载体**     | 内存中的虚拟转译流。                             | 物理磁盘上的纯净 JS 产物。                       |
| **启动时间**     | 含有转译等待（~数百毫秒）。                      | **瞬时启动（原生 V8 速度）。**                  |
| **调试支持**     | 内置热重载。                                     | 依赖 Source Map 及外部进程管理器（如 PM2）。     |
| **安全性**       | 低（含编译器，易被代码注入）。                   | **高（环境极简）。**                             |

## 12. 练习任务

1. **堆栈对比实验**：手动修改编译后的 `.js.map` 文件，观察 `node --enable-source-maps` 输出的行号是否会随之偏移。
2. **构建脚本编写**：在 `package.json` 中整合一个名为 `prod` 的脚本，依次执行清理、类型校验、编译、运行。
3. **Source Map 探秘**：使用文本编辑器打开一个 `.js.map` 文件，观察其中的 `mappings` 字段并结合 Base64 VLQ 编码原理进行初步了解。
